FROM node:16-alpine

ARG COMMIT
ARG NPM_USER
ARG NPM_PASS
ARG NPM_EMAIL
ARG NPM_REGISTRY

ENV LAST_COMMIT=${COMMIT}

ARG VSF_REDIS_ENABLED
ARG VSF_REDIS_HOST
ARG VSF_REDIS_PORT
ARG VSF_REDIS_CACHE_INVALIDATE_KEY
ARG VSF_REDIS_CACHE_INVALIDATE_URL

# REDIS_HOST and REDIS_PORT are reserverd environemnt variables for k8s
ENV VSF_REDIS_ENABLED=$VSF_REDIS_ENABLED
ENV VSF_REDIS_HOST=$VSF_REDIS_HOST
ENV VSF_REDIS_PORT=$VSF_REDIS_PORT
ENV VSF_REDIS_CACHE_INVALIDATE_KEY=$VSF_REDIS_CACHE_INVALIDATE_KEY
ENV VSF_REDIS_CACHE_INVALIDATE_URL=$VSF_REDIS_CACHE_INVALIDATE_URL

ARG API_BASE_URL
ARG API_SSR_BASE_URL

ARG MIDDLEWARE_ALLOWED_ORIGINS

ARG SAPCC_OAUTH_URI
ARG SAPCC_OAUTH_CLIENT_ID
ARG SAPCC_OAUTH_CLIENT_SECRET
ARG SAPCC_OAUTH_TOKEN_ENDPOINT
ARG SAPCC_OAUTH_TOKEN_REVOKE_ENDPOINT

ARG DEFAULT_BASE_SITE_ID
ARG DEFAULT_CATALOG_ID
ARG DEFAULT_CATALOG_VERSION
ARG DEFAULT_LANGUAGE
ARG DEFAULT_CURRENCY

ARG SAPCC_API_URI
ARG SAPCC_MEDIA_HOST

ARG NUXT_IMAGE_PROVIDER_UPLOAD_DIR
ARG NUXT_IMAGE_PROVIDER_BASE_URL

ENV API_BASE_URL=${API_BASE_URL}
ENV API_SSR_BASE_URL=${API_SSR_BASE_URL}

ENV MIDDLEWARE_ALLOWED_ORIGINS=${MIDDLEWARE_ALLOWED_ORIGINS}

ENV SAPCC_OAUTH_URI=${SAPCC_OAUTH_URI}
ENV SAPCC_OAUTH_CLIENT_ID=${SAPCC_OAUTH_CLIENT_ID}
ENV SAPCC_OAUTH_CLIENT_SECRET=${SAPCC_OAUTH_CLIENT_SECRET}
ENV SAPCC_OAUTH_TOKEN_ENDPOINT=${SAPCC_OAUTH_TOKEN_ENDPOINT}
ENV SAPCC_OAUTH_TOKEN_REVOKE_ENDPOINT=${SAPCC_OAUTH_TOKEN_REVOKE_ENDPOINT}

ENV DEFAULT_BASE_SITE_ID=${DEFAULT_BASE_SITE_ID}
ENV DEFAULT_CATALOG_ID=${DEFAULT_CATALOG_ID}
ENV DEFAULT_CATALOG_VERSION=${DEFAULT_CATALOG_VERSION}
ENV DEFAULT_LANGUAGE=${DEFAULT_LANGUAGE}
ENV DEFAULT_CURRENCY=${DEFAULT_CURRENCY}

ENV SAPCC_API_URI=${SAPCC_API_URI}
ENV SAPCC_MEDIA_HOST=${SAPCC_MEDIA_HOST}

ENV NUXT_IMAGE_PROVIDER_UPLOAD_DIR=${NUXT_IMAGE_PROVIDER_UPLOAD_DIR}
ENV NUXT_IMAGE_PROVIDER_BASE_URL=${NUXT_IMAGE_PROVIDER_BASE_URL}

WORKDIR /var/www

COPY middleware.js middleware.config.js multistore.config.js .npmrc .vuestorefrontcloud/docker/middleware/package.json ./

RUN npm install -g npm-cli-login && npm-cli-login \
    && yarn install --network-concurrency 1 \
    && yarn cache clean --all

EXPOSE 8181

ENTRYPOINT ["yarn", "start:middleware"]
